generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String             @id @default(cuid())
  name                  String?
  email                 String?            @unique
  emailVerified         DateTime?
  password              String?
  image                 String?
  role                  String             @default("candidate")
  archetype             String?
  supervisorId          String?
  totalLearningHours    Int                @default(0)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  accounts              Account[]          @relation("accounts")
  auditLogs             AuditLog[]
  courseEnrollments     CourseEnrollment[]
  feedbackReceived      Feedback[]         @relation("FeedbackTo")
  feedbackSent          Feedback[]         @relation("FeedbackFrom")
  dailyLearningSessions LearningSession[]
  reflections           Reflection[]
  sessions              Session[]
  skills                Skill[]
  testResults           TestResult[]
  supervisor            User?              @relation("SupervisorRelation", fields: [supervisorId], references: [id])
  learners              User[]             @relation("SupervisorRelation")

  @@index([role])
  @@index([archetype])
  @@index([supervisorId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation("accounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Archetype {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  roadmapId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roadmap     Roadmap? @relation(fields: [roadmapId], references: [id])

  @@index([name])
}

model Roadmap {
  id          String      @id @default(cuid())
  name        String
  archetype   String?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  archetypes  Archetype[]
  courses     Course[]
  modules     Module[]

  @@index([archetype])
}

model Module {
  id          String   @id @default(cuid())
  roadmapId   String
  name        String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  courses     Course[]
  roadmap     Roadmap  @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  @@index([roadmapId])
}

model Course {
  id          String             @id @default(cuid())
  title       String
  description String?
  difficulty  String             @default("beginner")
  roadmapId   String?
  moduleId    String?
  contentType String
  contentUrl  String?
  duration    Int?
  version     String             @default("1.0")
  createdBy   String?
  thumbnail   String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  module      Module?            @relation(fields: [moduleId], references: [id])
  roadmap     Roadmap?           @relation(fields: [roadmapId], references: [id])
  enrollments CourseEnrollment[]
  tests       Test[]

  @@index([roadmapId])
  @@index([moduleId])
  @@index([difficulty])
}

model CourseEnrollment {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  status      String    @default("in_progress")
  progress    Int       @default(0)
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model Test {
  id           String       @id @default(cuid())
  courseId     String
  title        String
  description  String?
  type         String       @default("mixed")
  timeLimit    Int?
  attemptLimit Int          @default(1)
  passingScore Int          @default(70)
  questions    String
  gradingType  String       @default("auto")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  results      TestResult[]

  @@index([courseId])
}

model TestResult {
  id            String    @id @default(cuid())
  userId        String
  testId        String
  score         Int
  status        String    @default("submitted")
  answers       String
  feedback      String?
  gradedBy      String?
  gradedAt      DateTime?
  attemptNumber Int       @default(1)
  startedAt     DateTime  @default(now())
  submittedAt   DateTime?
  createdAt     DateTime  @default(now())
  test          Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, testId, attemptNumber])
  @@index([userId])
  @@index([testId])
  @@index([status])
}

model LearningSession {
  id              String      @id @default(cuid())
  userId          String
  status          String      @default("active")
  startTime       DateTime    @default(now())
  endTime         DateTime?
  durationMinutes Int?
  notes           String?
  reflectionId    String?
  createdAt       DateTime    @default(now())
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  reflection      Reflection?

  @@index([userId])
  @@index([status])
}

model Reflection {
  id                String          @id @default(cuid())
  userId            String
  learningSessionId String          @unique
  courseId          String?
  text              String
  mood              String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  learningSession   LearningSession @relation(fields: [learningSessionId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model Skill {
  id              String   @id @default(cuid())
  userId          String
  name            String
  description     String?
  level           Int      @default(0)
  proficiency     Int      @default(0)
  evidenceCourses String?
  evidence        String?
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model Feedback {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  courseId   String?
  type       String   @default("comment")
  text       String
  rating     Int?
  isPrivate  Boolean  @default(false)
  threadId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  receiver   User     @relation("FeedbackTo", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("FeedbackFrom", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([courseId])
  @@index([threadId])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  targetType String?
  targetId   String?
  details    String?
  timestamp  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
}
